---
title: "Vulnerability"
output: html_document
---

## VULNERABILITY metric

# "6090429310" "6090470250" "6090618540"
# lignes: 25, 369, 2625

the function computes metrics related to land use, topography, and hydrolographic network on each hydrologic basin. 


```{r }

hydrobasin <- st_read(file.path(dir_data, "hydroshed","hydrobasins_level9", "hydrobasin_mg_lev9.shp"))
basins <- hydrobasin[c(25,369,2625),]

vulnerability = function(basins){
  
  hybas_id <- basins$HYBAS_ID
  
  # setting up output shapefile
  vuln_shp <- basins%>% mutate(topo=NA, nat_water=NA, dam=NA, lu_mb = NA, lu_modis = NA)

  for(i in hybas_id)  { #, .packages=c('dplyr', 'terra')) %dopar%  { 

      ligne = which(hybas_id==i)

    # loading mapbiomas extract
    load(file=file.path(dir_data, "processed", paste0("mapbiomas_extractbasin_",i,".RData")))
    df_trans <- cbind(df_export[,'x'],df_export[,'y'], df_export[,31])
    rast_biomas <- rasterFromXYZ(df_trans)
    
    # loading modis extract
    load(file=file.path(dir_data, "processed", paste0("pangaea_extractbasin_",i,".RData")))
    df_trans <- cbind(df_export[,'x'],df_export[,'y'], df_export[,'AMZ_2014_9_2015_8'])
    rast_modis <- rasterFromXYZ(df_trans)

    # loading elevation extract
    load(file=file.path(dir_data, "processed", paste0("elevation_extractbasin_",i,".RData")))
    df_elevation <- cbind(df_export[,'x'],df_export[,'y'], df_export[,'s10w055_con'])
    #rast_elevation <- rasterFromXYZ(df_trans)
    
    # loading flow accumulation extract
    load(file=file.path(dir_data, "processed", paste0("flowacc_extractbasin_",i,".RData")))
    df_trans <- cbind(df_export[,'x'],df_export[,'y'], df_export[,2])
    rast_flow <- rasterFromXYZ(df_trans)

    # loading water surface extract:
      # simple rivers
    riosimple <- st_read(file.path(dir_data, "processed", paste0("riossimple_poly",i,".shp")))
      # poly rivers
    #riospoly <- st_read(file.path(dir_data, "processed", paste0("riospoly_poly",i,".shp")))
      # sources
    source <- st_read(file.path(dir_data, "processed", paste0("source_poly",i,".shp")))
      # reservoirs 
    reservoir <- st_read(file.path(dir_data, "processed", paste0("lago_poly",i,".shp")))
    
    
    ### 1. Whole catchment factors ###
    
      # stream density (total stream length/ basin area)
    rios_length <- sum(st_length(riosimple))
    d_rios <- rios_length/st_area(basins[ligne,])
    
       # dam density (n dams/ basin area)
    n_dam <- dim(reservoir)[1]
    d_dam <- n_dam/st_area(basins[ligne,])
    
      # (mean) slope
    slope_mean <- mean(df_elevation[,3])
    
      # land use
    
    # mapbiomas

    score_mb <- length(which(getValues(rast_biomas) %in% c(14:21)))*1 - length(which(getValues(rast_biomas) %in% c(1:13))) + length(which(getValues(rast_biomas) %in% c(24,30)))
    
    # modis

    score_modis <- length(which(getValues(rast_modis) %in% c(104,106,108,109)))
    
    ### 2. Upstream catchment factors ###
    
      # filtering upstream: flow accumulation = 1

    rast_flow[rast_flow>1] <- NA # we set flow raster with NA for any value other than 1
    
    newflow_mb <- resample(rast_flow, rast_biomas, method = 'ngb') # we put flow raster (15 sec) at mapbiomas resolution (30m) 
    newflow_modis <- resample(rast_flow, rast_modis, method = 'ngb') # we put flow raster (15 sec) at modis resolution (250m) 
    
      # mapbiomas masking
    biom_mask <- terra::mask(rast_biomas, newflow_mb) # we mask mapbiomas on upstream area

      # modis masking
    modis_mask <- terra::mask(rast_modis, newflow_modis) # we mask mapbiomas on upstream area
    
      # scoring land use
    
    
    ### 3. Score computing ###
    

    vuln_shp[ligne,] <- basins[ligne,] %>% mutate(topo=slope_mean, nat_water=d_rios, dam=d_dam, lu_mb = score_mb, lu_modis = score_modis)


  }
  
  st_write(vuln_shp, file.path(dir_data, "vulnerability","vulnerability_1.shp"))

  return(vuln_shp)
}


    
```
