---
title: "Vulnerability"
output: html_document
---

## VULNERABILITY metric

# full forest:"6090521840"; mixed forest-temp crops: "6090541370"; full livestock: "6090612410"
# lignes: 444; 821; 3126
# year 2015 > bio_30

the function computes metrics related to land use, topography, and hydrolographic network on each hydrologic basin. 


```{r }

hydrobasin <- st_read(file.path(dir_data, "hydroshed","hydrobasins_level9", "hydrobasin_mg_lev9.shp"))
basin_test <- hydrobasin[c(444,821,3126),]

vulnerability = function(basins){
  
  hybas_id <- basins$HYBAS_ID
  lat_weight <- cos(pi*mean(st_coordinates(basins)[,'Y'])/180)
##############################################################


      
    # loading mapbiomas extract
    load(file=file.path(dir_data, "processed", paste0("mapbiomas_extractbasin_",hybas_id,".RData")))
    spp_biomas <- st_as_sf(df_export[,c('x','y','bio_30', 'fraction')], coords = c("x","y"), crs = "+proj=longlat +datum=WGS84")#

    # loading modis extract
    load(file=file.path(dir_data, "processed", paste0("pangaea_extractbasin_",hybas_id,".RData")))
    spp_modis <- st_as_sf(df_export[,c('x','y','AMZ_2014_9_2015_8', 'fraction')], coords = c("x","y"), crs = "+proj=longlat +datum=WGS84")

    # loading elevation extract
    load(file=file.path(dir_data, "processed", paste0("elevation_extractbasin_",hybas_id,".RData")))
    spp_elevation <- st_as_sf(df_export[,c('x','y','s10w055_con')], coords = c("x","y"), crs = "+proj=longlat +datum=WGS84")
    
    # loading flow accumulation extract
    load(file=file.path(dir_data, "processed", paste0("flowacc_extractbasin_",hybas_id,".RData")))
    spp_flow <- st_as_sf(df_export[,c('x','y','sa_acc_15s')], coords = c("x","y"), crs = "+proj=longlat +datum=WGS84") 

    # loading water surface extract:
      # simple rivers
    riosimple <- st_read(file.path(dir_data, "processed", paste0("riossimple_poly",hybas_id,".shp")))
      # poly rivers
    #riospoly <- st_read(file.path(dir_data, "processed", paste0("riospoly_poly",i,".shp")))
      # sources
    source <- st_read(file.path(dir_data, "processed", paste0("source_poly",hybas_id,".shp")))
      # reservoirs 
    reservoir <- st_read(file.path(dir_data, "processed", paste0("lago_poly",hybas_id,".shp")))
    
                     #######################################################################
    
    
                                      ### 1. Whole catchment factors ###
    
    
      ### STREAM DENSITY (total stream length/ basin area)
    # rios_length <- sum(st_length(riosimple))
    # d_rios <- rios_length/st_area(basins[ligne,])
    
      ### DAM DENSITY (n dams/ basin area)
    n_dam <- dim(reservoir)[1]
    d_dam <- n_dam/st_area(basins)
    
      ### SLOPE (mean)
    # slope_mean <- mean(spp_elevation$s10w055_con)
    
      ### DISTANCE TO CLOSEST STREAM (mapbiomas data)
    
        # minimum distance
    # dist <- vector()
    # spp_biomas_agr <- spp_biomas %>% filter(bio_30 %in% c(14:21))
    # tictoc::tic()
    # for (cell in c(1:dim(spp_biomas_agr)[1])){
    #     dist[cell] <- min(distance(vect(spp_biomas_agr[cell,]), vect(source)))
    # }
    # toc()
    # 
    # mean_min_d <- mean(dist)
    
      ### LAND USE %
    
        ## Mapbiomas
    basin_surface_mb <- sum(spp_biomas$fraction)*900
    soy <- sum((spp_biomas %>% filter(bio_30==39))$fraction)*900/basin_surface_mb
    sug_mb <- sum((spp_biomas %>% filter(bio_30==20))$fraction)*900/basin_surface_mb
    temp <- sum((spp_biomas %>% filter(bio_30==41))$fraction)*900/basin_surface_mb
    perm <- sum((spp_biomas %>% filter(bio_30==36))$fraction)*900/basin_surface_mb
    past_mb <- sum((spp_biomas %>% filter(bio_30==15))$fraction)*900/basin_surface_mb
    agrpast <- sum((spp_biomas %>% filter(bio_30==21))$fraction)*900/basin_surface_mb
    aquacult <- sum((spp_biomas %>% filter(bio_30==31))$fraction)*900/basin_surface_mb
    wet <- sum((spp_biomas %>% filter(bio_30==11))$fraction)*900/basin_surface_mb
    forest_mb <- sum((spp_biomas %>% filter(bio_30 %in% c(3,4,5,9)))$fraction)*900/basin_surface_mb # forest, savanna, mangrove

        ## Modis
    basin_surface_md <- sum(spp_modis$fraction)*62500
cotton_fallow <- sum((spp_modis %>% filter(AMZ_2014_9_2015_8 == 100))$fraction)*62500/basin_surface_md
    soy_fallow <- sum((spp_modis %>% filter(AMZ_2014_9_2015_8 == 99))$fraction)*62500/basin_surface_md
    millet_cotton <- sum((spp_modis %>% filter(AMZ_2014_9_2015_8 == 104))$fraction)*62500/basin_surface_md
    soy_millet <- sum((spp_modis %>% filter(AMZ_2014_9_2015_8 == 106))$fraction)*62500/basin_surface_md
    soy_corn <- sum((spp_modis %>% filter(AMZ_2014_9_2015_8 == 109))$fraction)*62500/basin_surface_md
    soy_cotton <- sum((spp_modis %>% filter(AMZ_2014_9_2015_8 == 108))$fraction)*62500/basin_surface_md
    past_modis <- sum((spp_modis %>% filter(AMZ_2014_9_2015_8 == 130))$fraction)*62500/basin_surface_md
    forest_modis <- sum((spp_modis %>% filter(AMZ_2014_9_2015_8 == 7))$fraction)*62500/basin_surface_md # forest, savanna
    sug_modis <- sum((spp_modis %>% filter(AMZ_2014_9_2015_8 == 97))$fraction)*62500/basin_surface_md

      ### PATCHING %

        ## Mapbiomas
        
    # patch_forest <- 
    # patch_rv <- 
      
      
                          #######################################################################

      
                                    ### 2. Upstream catchment factors ###
    
    
      # filtering upstream: flow accumulation = 1
    
    # spp_flow_up <- spp_flow %>% filter(sa_acc_15s==1)  # we filter values above 1
    # spp_flow_buf <- st_buffer(spp_flow_up, dist = 50) # we convert spatial points to polygons, needed for landuse spatialpoint filtering
    # 
    #   # mapbiomas masking
    # spp_biom_mask <- st_crop(spp_biomas, spp_flow_buf)
    # 
    #   # modis masking
    # spp_modis_mask <- st_crop(spp_modis, spp_flow_buf)
    # 
    #   # scoring land use
    # score_int <- length(which(spp_biom_mask$sa_acc_15s %in% c(104,106,108,109)))
    # score_biomas_up <- score_int*900/sum(st_area(spp_flow_buf))
    # 
    # score_int2 <- length(which(spp_modis_mask$AMZ_2014_9_2015_8 %in% c(104,106,108,109)))
    # score_modis_up <- score_int2*62500/sum(st_area(spp_flow_buf))

    
    ### 3. Score computing ###
    

    vuln_shp<- basins %>% mutate(soy=soy, sug_mb=sug_mb, temp=temp, perm = perm, past_mb = past_mb, agrpast = agrpast, aquacult = aquacult, wet = wet, forest_mb = forest_mb, cotton_fallow = cotton_fallow, soy_fallow = soy_fallow, millet_cotton = millet_cotton, soy_millet = soy_millet, soy_corn = soy_corn, soy_cotton = soy_cotton, past_modis = past_modis, forest_modis = forest_modis, sug_modis = sug_modis, d_dam = d_dam)

  st_write(vuln_shp, file.path(dir_data, "vulnerability",paste0("vulnerability_", hybas_id, ".shp")), delete_layer = TRUE)



}



tictoc::tic()
vulnerability(basin_test[1,])
tictoc::toc()
   
tictoc::tic()
   no_cores <- detectCores()
   cl <- makeCluster(no_cores) # setting up number of cores
   registerDoParallel(cl) # parallelizing on them
   foreach(i = c(1:30), .packages=c('dplyr', 'terra', 'sf')) %dopar%  { 
   vulnerability(basin_test[i,])
   }
   stopCluster(cl)
tictoc::toc()

```
