---
title: "Data preprocessing"
output: html_document
---
## Directories

# Reminder:
#hydrobasins <- shapefile(file.path(dir_data, "hydroshed","hydrobasins_level9","hydrobasin_mg_lev9.shp"))
#hydronetwork <- shapefile(file.path(dir_data, "water_surface", "second.shp"))
#hydronetwork <- readOGR(dsn=file.path(dir_data, "water_surface", "second.shp"))

```{r }

if ((Sys.info()["nodename"]) == "COP026") {
  dir_data <- "C:/Users/arvor_d/Documents/workwork/data"
  dir_plot <- "C:/Users/arvor_d/Documents/workwork/plot"
} else if ((Sys.info()["nodename"]) == "COSTELSV6") {
  dir_data <- "F:/kamir_e/$data"
  dir_plot <- "F:/kamir_e/$plot "
}

```

## Library

```{r setup, include=FALSE}

library(plyr)
library(tidyverse)
library(tidyr)
library(dplyr)
library(foreach)
library(iterators)
library(lwgeom)
library(parallel)
library(doParallel)
library(maps)
library(nnet)
library(ggplot2)
library(latticeExtra)
library(sp)
library(rgdal)
library(raster)
library(stringi)
library(ggmap)
library(sf)
library(stars)
library(terra)

```


## HYDROBASINS: Cropping SHP to mato grosso extent


```{r }

# Mato Grosso border shapefile
mg_borders <- shapefile(file.path(dir_data, "boundaries","mato grosso", "mt84.shp"))

# Hydroshed hydrobasins at level 9
hydrobasins <- shapefile(file.path(dir_data, "hydroshed","hydrobasins_level9", "hybas_sa_lev09_v1c.shp"))

# Cropping 
hydrobasin_mg <- intersect(hydrobasins, mg_borders)

# Writing output shapefile
writeOGR(hydrobasin_mg, layer = "hydrobasin_mg_lev9", driver="ESRI Shapefile", dsn= file.path(dir_data, "hydroshed","hydrobasins_level9"), overwrite_layer = TRUE)

```

## PANGAEA: Stacking/ cropping file to mato grosso extent

```{r }

panga_braz <- rast(file.path(dir_data, "pangaea", paste0("AMZ_",2000,"_9_", 2001,"_8",".tif")))

# Mato Grosso border shapefile
mg_borders <- st_read(file.path(dir_data, "boundaries","mato grosso", "mt84.shp"))

# Hydroshed hydrobasins at level 9
for (i in c(2001:2017)){
  newlayer <- rast(file.path(dir_data, "pangaea", paste0("AMZ_",i,"_9_", i+1,"_8",".tif")))
  panga_braz <- c(panga_braz, newlayer)
}

# Reprojecting on WGS84
crs <- "+proj=longlat +datum=WGS84"
panga_braz84 <- project(panga_braz, crs)

# Cropping 
panga_braz_mt <- crop(panga_braz84, vect(mg_borders))

# Writing output shapefile
#writeRaster(panga_braz84, file = file.path(dir_data, "pangaea", "panga_braz84.tif"))
writeRaster(panga_braz_mt, file = file.path(dir_data, "pangaea", "panga_braz84_mt.tif"))


```

## PANGAEA: cropping on mato grosso extent

```{r }

# Loading
panga_braz84 <- rast(file.path(dir_data, "pangaea", "panga_braz84.tif"))

# Cropping 
panga_braz_mt <- crop(panga_braz84, vect(mg_borders))

# Writing output shapefile
writeRaster(panga_braz_mt, file = file.path(dir_data, "pangaea", "panga_braz84_mt.tif"))

```

## ELEVATION: cropping file to mato grosso extent

```{r }


# Mato Grosso border shapefile
mg_borders <- st_read(file.path(dir_data, "boundaries","mato grosso", "mt84.shp"))

# Elevation
elevation <- rast(file.path(dir_data, "hydroshed", "hydrocon elevation", "elevation_merge.tif"))

plot(elevation)
plot(mg_borders, add=TRUE)

# Cropping 
elevation_crop <- crop(elevation, vect(mg_borders))

plot(elevation_crop)
plot(mg_borders, add=TRUE)

# Writing output raster
writeRaster(elevation_crop, file = file.path(dir_data, "hydroshed", "hydrocon elevation", "elevation_crop.tif"))


```

## WATER SURFACES: cropping on hydrobasin extents

We crop and save each hydrobasin-cropped file

```{r }

### 1. LOADING HYDROBASINS ###

hydrobasins <- st_read(file.path(dir_data, "hydroshed","hydrobasins_level9","hydrobasin_mg_lev9.shp"))


### 2. CROPPING FILES ON HYDORBASIN EXTENTS ###

  ## SIMPLE LINE STREAMS ##

  # hydrographic network on MG
  hydronetwork <- st_read(file.path(dir_data, "water_surface", "rios_simples", "rios_simple84.shp"))
  
  no_cores <- detectCores()
  cl <- makeCluster(no_cores-1) # setting up number of cores
  registerDoParallel(cl) # parallelizing on them
  
  foreach(i=1:dim(hydrobasins)[1], .packages=c('sf')) %dopar%  { #
      # cropping single rivers on watershed level
    crop_list <- st_intersects(hydrobasins[i,],hydronetwork)
    crop_shp <- hydronetwork[unlist(crop_list),]
    st_write(crop_shp, file.path(dir_data, "processed",paste0("cropped_lev09hydrnetw",i-1,".shp")), delete_layer = TRUE)
  
   }
  
  stopCluster(cl)
  
  ## POLY LINE STREAMS ##
  
  # poly-hydrographic network on MG
  polynetwork <- st_read(file.path(dir_data, "water_surface", "rios_poly", "output_hidro_poly.shp"))
  
  no_cores <- detectCores()
  cl <- makeCluster(no_cores-1) # setting up number of cores
  registerDoParallel(cl) # parallelizing on them
  
  foreach(i=1:dim(hydrobasins)[1], .packages=c('sf')) %dopar%  { #
      # cropping single rivers on watershed level
    crop_list <- st_intersects(hydrobasins[i,],polynetwork)
    poly_shp <- polynetwork[unlist(crop_list),]
    st_write(poly_shp, file.path(dir_data, "processed",paste0("poly_crop9",i-1,".shp")), delete_layer = TRUE)
  
   }
  
  stopCluster(cl)
  
  ## WATER RESERVOIRS ##
  
  #lake network on MG
  lago <- st_read(file.path(dir_data, "water_surface", "lago", "input_lago_reservatorio_icv.shp"))
  
  no_cores <- detectCores()
  cl <- makeCluster(no_cores-1) # setting up number of cores
  registerDoParallel(cl) # parallelizing on them
  
  foreach(i=1:dim(hydrobasins)[1], .packages=c('sf')) %dopar%  { #
      # cropping single rivers on watershed level
    crop_list <- st_intersects(hydrobasins[i,],lago)
    lago_shp <- lago[unlist(crop_list),]
    st_write(lago_shp, file.path(dir_data, "processed",paste0("lago_crop9_",i-1,".shp")), delete_layer = TRUE)
  
   }
  
  stopCluster(cl)
  
  
  
  ## SOURCE ##
  
  # source network on MG
  nascente <- st_read(file.path(dir_data, "water_surface", "nascentes", "nascente84.shp"))
  
  no_cores <- detectCores()
  cl <- makeCluster(no_cores-1) # setting up number of cores
  registerDoParallel(cl) # parallelizing on them
  
  foreach(i=1:dim(hydrobasins)[1], .packages=c('sf')) %dopar%  { #
      # cropping single rivers on watershed level
    crop_list <- st_intersects(hydrobasins[i,],nascente)
    nascente_shp <- nascente[unlist(crop_list),]
    st_write(nascente_shp, file.path(dir_data, "processed",paste0("source_crop9_",i-1,".shp")), delete_layer = TRUE)
  
   }
  
  stopCluster(cl)
  
  
```




