---
title: "Vulnerability"
output: html_document
---

## VULNERABILITY metric

the function computes metrics related to land use, topography, and hydrolographic network on each hydrologic basin. 

NB/ erreurs sur polygones 6090488410 et 6090485390 - d√ªes a rios simple

```{r }

vulnerability = function(hydrobasin, hybas_id, year, time_span){
  
  basin <- hydrobasin %>% filter(HYBAS_ID==hybas_id)

  year_index=which(year==time_span)

    # loading mapbiomas extract
    df_biomas <- get(load(file=file.path(dir_data, "processed", paste0("mapbiomas_extractbasin_",hybas_id,".RData")))) %>% rename(value=year_index+1)
    spp_biomas <- st_as_sf(cbind(value=df_biomas[,year_index+1],df_biomas[,c('x','y', 'fraction')]), coords = c("x","y"), crs = "+proj=longlat +datum=WGS84")#

    # loading elevation extract
    load(file=file.path(dir_data, "processed", paste0("elevation_extractbasin_",hybas_id,".RData")))
    spp_elevation <- st_as_sf(df_export[,c('x','y','s10w055_con')], coords = c("x","y"), crs = "+proj=longlat +datum=WGS84")
    
    # loading flow accumulation extract
    load(file=file.path(dir_data, "processed", paste0("flowacc_extractbasin_",hybas_id,".RData")))
    spp_flow <- st_as_sf(df_export[,c('x','y','sa_acc_15s')], coords = c("x","y"), crs = "+proj=longlat +datum=WGS84") 

    # loading water surface extract:
      # simple rivers
    riosimple <- st_read(file.path(dir_data, "water_surface", "rios_simples", paste0("riossimple_poly",hybas_id,".shp")))
      # poly rivers
    #riospoly <- st_read(file.path(dir_data, "processed", paste0("riospoly_poly",i,".shp")))
      # sources
    source <- st_read(file.path(dir_data, "water_surface", "nascentes", paste0("source_poly",hybas_id,".shp")))
      # reservoirs 
    reservoir <- st_read(file.path(dir_data, "water_surface", "lago", paste0("lago_poly",hybas_id,".shp")))
      

                     #######################################################################
    
    
                                      ### 1. Whole catchment factors ###
    
    
      ### STREAM DENSITY (total stream length/ basin area)
    # rios_length <- sum(st_length(riosimple))
    # d_rios <- rios_length/st_area(basins[ligne,])
    
      ### DAM DENSITY (n dams/ basin area)
    n_dam <- dim(reservoir)[1]
    #d_dam <- n_dam/st_area(basins)
    
      ### SLOPE (mean)
    # slope_mean <- mean(spp_elevation$s10w055_con)
    
    
      ### LAND USE % ###
    
        ## Mapbiomas ##

    basin_surface_mb <- sum(df_biomas$fraction)*900
 
    soy <- sum((df_biomas %>% filter(value==39))$fraction)*900/basin_surface_mb
    sug_ma <- sum((df_biomas %>% filter(value==20))$fraction)*900/basin_surface_mb
    temp <- sum((df_biomas %>% filter(value==41))$fraction)*900/basin_surface_mb
    perm <- sum((df_biomas %>% filter(value==36))$fraction)*900/basin_surface_mb
    past_ma <- sum((df_biomas %>% filter(value==15))$fraction)*900/basin_surface_mb
    agrpast <- sum((df_biomas %>% filter(value==21))$fraction)*900/basin_surface_mb
    aquaclt <- sum((df_biomas %>% filter(value==31))$fraction)*900/basin_surface_mb
    wet <- sum((df_biomas %>% filter(value==11))$fraction)*900/basin_surface_mb
    foret_ma <- sum((df_biomas %>% filter(value==3))$fraction)*900/basin_surface_mb
    sav <- sum((df_biomas %>% filter(value==4))$fraction)*900/basin_surface_mb
    mang <- sum((df_biomas %>% filter(value==5))$fraction)*900/basin_surface_mb
    forplan <- sum((df_biomas %>% filter(value==9))$fraction)*900/basin_surface_mb

        ## Modis ##
    
    if(year %in% c(2000:2017)){
      
              # loading modis extract
    df_modis <- get(load(file=file.path(dir_data, "processed", paste0("pangaea_extractbasin_",hybas_id,".RData"))))%>% rename(value=year_index-14)
    spp_modis <- st_as_sf(cbind(value=df_modis[,year_index-14],df_modis[,c('x','y', 'fraction')]), coords = c("x","y"), crs = "+proj=longlat +datum=WGS84")

    basin_surface_md <- sum(df_modis$fraction)*62500
    
    ct_fl <- sum((df_modis %>% filter(value == 100))$fraction)*62500/basin_surface_md
    sy_fllw <- sum((df_modis %>% filter(value == 99))$fraction)*62500/basin_surface_md
    mllt_ct <- sum((df_modis %>% filter(value == 104))$fraction)*62500/basin_surface_md
    sy_mllt <- sum((df_modis %>% filter(value == 106))$fraction)*62500/basin_surface_md
    sy_crn <- sum((df_modis %>% filter(value == 109))$fraction)*62500/basin_surface_md
    sy_ct <- sum((df_modis %>% filter(value == 108))$fraction)*62500/basin_surface_md
    past_mo <- sum((df_modis %>% filter(value == 130))$fraction)*62500/basin_surface_md
    foret_mo <- sum((df_modis %>% filter(value == 7))$fraction)*62500/basin_surface_md # forest, savanna
    sav_mo <- sum((df_modis %>% filter(value == 51))$fraction)*62500/basin_surface_md # forest, savanna
    sug_mo <- sum((df_modis %>% filter(value == 97))$fraction)*62500/basin_surface_md

    }
 
    else { ct_fl <- NA; sy_fllw <- NA; mllt_ct <- NA; sy_mllt <- NA; sy_crn <- NA; sy_ct <- NA; past_mo <- NA; foret_mo <- NA; sav_mo <- NA;                sug_mo <- NA }
      
                          #######################################################################

      
                                    ### 2. Upstream catchment factors ###
    
    ### FIRST ORDER STREAMS
    tictoc::tic()
      # buffering every water source
    buf_source <- st_buffer(source, dist=0.0000001) 
      # extracting stream within buffer (= 1 per source = first order stream)
    stream_source <- st_crosses(buf_source,riosimple, sparse = TRUE) 
      # filtering UPSTREAM streams
    rios_upstream <- riosimple[unlist(stream_source),]
      # buffering upstream streams (100 meters)
    tictoc::tic()
    buf_stream <- st_buffer(rios_upstream, dist=500) # creating buffer around every water source
    tictoc::toc()

    ### COUNTING NUMBER OF CROP PIXELS WITHIN stream buffer
    
        # minimum distance
     tictoc::tic()
     mapbiom_up <- st_intersects(spp_biomas, buf_stream, sparse = TRUE)
     
     # mapbiom_up <- st_crosses(spp_biomas, rios_upstream, dist = 100)
     # mapbiom_up <- st_within(spp_biomas, rios_upstream)

     up_area <- nrow(df_biomas[unlist(mapbiom_up),])*900
     
     for_up <- nrow(df_biomas[unlist(mapbiom_up),] %>% filter(value==3))*900/up_area
     tictoc::toc()

    
    ### 3. Score computing ###

        ## Modis ##


    vuln_shp<- basin %>% mutate(for_up=for_up, soy=soy, sug_ma=sug_ma, temp=temp, perm = perm, past_ma = past_ma, agrpast = agrpast, aquaclt = aquaclt, wet = wet, foret_ma = foret_ma, sav=sav, mang=mang, forplan=forplan, ct_fl = ct_fl, sy_fllw = sy_fllw, mllt_ct = mllt_ct, sy_mllt = sy_mllt, sy_crn = sy_crn, sy_ct = sy_ct, past_mo = past_mo, foret_mo = foret_mo, sav_mo=sav_mo, sug_mo = sug_mo, n_dam = n_dam)

  st_write(vuln_shp, file.path(dir_data, "vulnerability",paste0(year,"_vulnerability_", hybas_id, ".shp")), delete_layer = TRUE)


}


                                  ##################################################################


hydrobasin <- st_read(file.path(dir_data, "hydroshed","hydrobasins_level9", "hydrobasin_mg_lev9.shp"))
basin_id <- hydrobasin$HYBAS_ID
time_span <- c(1985:2019)
# see debugging
poly_pasok <- c(567,602,639,663,685,696,756,1004,1131) #which(vecttrue)

load(file = file.path(dir_plot, "1000randomid.RData"))

tictoc::tic()
   no_cores <- detectCores()
   cl <- makeCluster(no_cores) # setting up number of cores
   registerDoParallel(cl) # parallelizing on them
   foreach(i = basin_id, .packages=c('dplyr', 'terra', 'sf')) %dopar%  {
     
     for (y in time_span){ #[seq(1,18,3)]
      vulnerability(hydrobasin[-poly_pasok,], i, y, time_span)
       gc()
     }
     
   }
   stopCluster(cl)
tictoc::toc()

####################################

gc()

y <- 2012
tictoc::tic()
   no_cores <- detectCores()
   cl <- makeCluster(no_cores) # setting up number of cores
   registerDoParallel(cl) # parallelizing on them
   foreach(i = basin_id, .packages=c('dplyr', 'terra', 'sf')) %dopar%  {
     
      vulnerability(hydrobasin, i, y, time_span)
       gc()
     
   }
   stopCluster(cl)
tictoc::toc()


```


## MERGING INDIVIDUAL SHAPEFILES INTO SINGLE ONE

One shp per year

```{r }


for (y in time_span){
  
  sf_list_name <- list.files(path=file.path(dir_data, "vulnerability"), pattern = paste0(y,"_vulnerability",".+.shp"), full.names = TRUE)
  sf_list_file <- lapply(sf_list_name, st_read)
    
  
  df_f <- do.call("rbind",sf_list_file)
  
  st_write(df_f, file.path(dir_data, "vulnerability", "yearly", paste0(y, "_whole_vulnerability.shp")), delete_layer = TRUE)

}

y<-time_span[length(time_span)]
```