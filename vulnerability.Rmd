---
title: "Vulnerability"
output: html_document
---

## VULNERABILITY metric

# full forest:"6090521840"; mixed forest-temp crops: "6090541370"; full livestock: "6090612410"
# lignes: 444; 821; 3126
# 

# new smart selection

6090572470,6090588890,6090629780,6090612720,6090601850,6090535530,6090547860,6090601850,6090566330,6090613000,6090595300,6090510180,6090531830,6090527450,6090524660,6090499970,6090502220,6090484790,6090536080,6090509600,6090529510,6090525490,6090552830,6090550430,6090560950,6090483660,6090543710,6090558840,6090553570,6090567110


the function computes metrics related to land use, topography, and hydrolographic network on each hydrologic basin. 


```{r }
hydrobasin <- st_read(file.path(dir_data, "hydroshed","hydrobasins_level9", "hydrobasin_mg_lev9.shp"))
basin_test <- hydrobasin[c(444,821,3126),]

vulnerability = function(hydrobasin, hybas_id, year, time_span){
  
  basin <- hydrobasin %>% filter(HYBAS_ID==hybas_id)

  year_index=which(year==time_span)
  #hybas_id <- basin$HYBAS_ID

           tictoc::tic()

    # loading mapbiomas extract
    df_biomas <- get(load(file=file.path(dir_data, "processed", paste0("mapbiomas_extractbasin_",hybas_id,".RData")))) 
    
    spp_biomas <- st_as_sf(cbind(value=df_export[,year_index+16],df_export[,c('x','y', 'fraction')]), coords = c("x","y"), crs = "+proj=longlat +datum=WGS84")#

    # loading modis extract
    load(file=file.path(dir_data, "processed", paste0("pangaea_extractbasin_",hybas_id,".RData")))
    spp_modis <- st_as_sf(cbind(value=df_export[,year_index+1],df_export[,c('x','y', 'fraction')]), coords = c("x","y"), crs = "+proj=longlat +datum=WGS84")

    # loading elevation extract
    load(file=file.path(dir_data, "processed", paste0("elevation_extractbasin_",hybas_id,".RData")))
    spp_elevation <- st_as_sf(df_export[,c('x','y','s10w055_con')], coords = c("x","y"), crs = "+proj=longlat +datum=WGS84")
    
    # loading flow accumulation extract
    load(file=file.path(dir_data, "processed", paste0("flowacc_extractbasin_",hybas_id,".RData")))
    spp_flow <- st_as_sf(df_export[,c('x','y','sa_acc_15s')], coords = c("x","y"), crs = "+proj=longlat +datum=WGS84") 

    # loading water surface extract:
      # simple rivers
    riosimple <- st_read(file.path(dir_data, "water_surface", "rios_simples", paste0("riossimple_poly",hybas_id,".shp")))
      # poly rivers
    #riospoly <- st_read(file.path(dir_data, "processed", paste0("riospoly_poly",i,".shp")))
      # sources
    source <- st_read(file.path(dir_data, "water_surface", "nascentes", paste0("source_poly",hybas_id,".shp")))
      # reservoirs 
    reservoir <- st_read(file.path(dir_data, "water_surface", "lago", paste0("lago_poly",hybas_id,".shp")))
      
       tictoc::toc()

                     #######################################################################
    
    
                                      ### 1. Whole catchment factors ###
    
    
      ### STREAM DENSITY (total stream length/ basin area)
    # rios_length <- sum(st_length(riosimple))
    # d_rios <- rios_length/st_area(basins[ligne,])
    
      ### DAM DENSITY (n dams/ basin area)
    n_dam <- dim(reservoir)[1]
    #d_dam <- n_dam/st_area(basins)
    
      ### SLOPE (mean)
    # slope_mean <- mean(spp_elevation$s10w055_con)
    
    
      ### LAND USE % ###
    
        ## Mapbiomas ##

       tictoc::tic()
    basin_surface_mb <- sum(df_biomas$fraction)*900
    df_biomas[, year_index] %>% 
    soy <- sum((spp_biomas %>% filter(value==39))$fraction)*900/basin_surface_mb
    sug_ma <- sum((spp_biomas %>% filter(value==20))$fraction)*900/basin_surface_mb
    temp <- sum((spp_biomas %>% filter(value==41))$fraction)*900/basin_surface_mb
    perm <- sum((spp_biomas %>% filter(value==36))$fraction)*900/basin_surface_mb
    past_ma <- sum((spp_biomas %>% filter(value==15))$fraction)*900/basin_surface_mb
    agrpast <- sum((spp_biomas %>% filter(value==21))$fraction)*900/basin_surface_mb
    aquacult <- sum((spp_biomas %>% filter(value==31))$fraction)*900/basin_surface_mb
    wet <- sum((spp_biomas %>% filter(value==11))$fraction)*900/basin_surface_mb
    foret_ma <- sum((spp_biomas %>% filter(value==3))$fraction)*900/basin_surface_mb
    sav <- sum((spp_biomas %>% filter(value==4))$fraction)*900/basin_surface_mb
    mang <- sum((spp_biomas %>% filter(value==5))$fraction)*900/basin_surface_mb
    forplan <- sum((spp_biomas %>% filter(value==9))$fraction)*900/basin_surface_mb

        ## Modis ##
        

    basin_surface_md <- sum(spp_modis$fraction)*62500
    cotton_fallow <- sum((spp_modis %>% filter(value == 100))$fraction)*62500/basin_surface_md
    soy_fallow <- sum((spp_modis %>% filter(value == 99))$fraction)*62500/basin_surface_md
    millet_cotton <- sum((spp_modis %>% filter(value == 104))$fraction)*62500/basin_surface_md
    soy_millet <- sum((spp_modis %>% filter(value == 106))$fraction)*62500/basin_surface_md
    soy_corn <- sum((spp_modis %>% filter(value == 109))$fraction)*62500/basin_surface_md
    soy_cotton <- sum((spp_modis %>% filter(value == 108))$fraction)*62500/basin_surface_md
    past_mo <- sum((spp_modis %>% filter(value == 130))$fraction)*62500/basin_surface_md
    foret_mo <- sum((spp_modis %>% filter(value == 7))$fraction)*62500/basin_surface_md # forest, savanna
    sav_mo <- sum((spp_modis %>% filter(value == 51))$fraction)*62500/basin_surface_md # forest, savanna
    sug_mo <- sum((spp_modis %>% filter(value == 97))$fraction)*62500/basin_surface_md
 
       tictoc::toc()

      ### PATCHING %

        ## Mapbiomas
        
    # patch_forest <- 
    # patch_rv <- 
      
      
                          #######################################################################

      
                                    ### 2. Upstream catchment factors ###
    
    ### FIRST ORDER STREAMS
    tictoc::tic()
      # buffering every water source
    buf_source <- st_buffer(source, dist=0.0000001) 
      # extracting stream within buffer (= 1 per source = first order stream)
    stream_source <- st_crosses(buf_source,riosimple, sparse = TRUE) 
      # filtering UPSTREAM streams
    rios_upstream <- riosimple[unlist(stream_source),]
      # buffering upstream streams (100 meters)
    tictoc::tic()
    buf_stream <- st_buffer(rios_upstream, dist=100) # creating buffer around every water source
    tictoc::toc()

    ### COUNTING NUMBER OF CROP PIXELS WITHIN stream buffer
    
        # minimum distance
     tictoc::tic()
     mapbiom_up <- st_intersects(spp_biomas, buf_stream, sparse = TRUE)
     
     # mapbiom_up <- st_crosses(spp_biomas, rios_upstream, dist = 100)
     # mapbiom_up <- st_within(spp_biomas, rios_upstream)


     for_up <- nrow(spp_biomas[unlist(mapbiom_up),] %>% filter(value==3))*900/basin_surface_mb
     tictoc::toc()

          # filtering upstream: flow accumulation = 1
    
    # spp_flow_up <- spp_flow %>% filter(sa_acc_15s==1)  # we filter values above 1
    # spp_flow_buf <- st_buffer(spp_flow_up, dist = 50) # we convert spatial points to polygons, needed for landuse spatialpoint filtering
    # 
    #   # mapbiomas masking
    # spp_biom_mask <- st_crop(spp_biomas, spp_flow_buf)
    # 
    #   # modis masking
    # spp_modis_mask <- st_crop(spp_modis, spp_flow_buf)
    # 
    #   # scoring land use
    # score_int <- length(which(spp_biom_mask$sa_acc_15s %in% c(104,106,108,109)))
    # score_biomas_up <- score_int*900/sum(st_area(spp_flow_buf))
    # 
    # score_int2 <- length(which(spp_modis_mask$AMZ_2014_9_2015_8 %in% c(104,106,108,109)))
    # score_modis_up <- score_int2*62500/sum(st_area(spp_flow_buf))

    
    ### 3. Score computing ###
    

    vuln_shp<- basin %>% mutate(for_up=for_up, soy=soy, sug_ma=sug_ma, temp=temp, perm = perm, past_ma = past_ma, agrpast = agrpast, aquacult = aquacult, wet = wet, foret_ma = foret_ma, sav=sav, mang=mang, forplan=forplan, cotton_fallow = cotton_fallow, soy_fallow = soy_fallow, millet_cotton = millet_cotton, soy_millet = soy_millet, soy_corn = soy_corn, soy_cotton = soy_cotton, past_mo = past_mo, foret_mo = foret_mo, sav_mo=sav_mo, sug_mo = sug_mo, n_dam = n_dam)

  st_write(vuln_shp, file.path(dir_data, "vulnerability",paste0(year,"_vulnerability_", hybas_id, ".shp")), delete_layer = TRUE)



}



tictoc::tic()
vulnerability(hydrobasin, 6090484790, 2004, time_span[1:10])
tictoc::toc()

time_span <- c(2000:2018)

#basin_id<-c(6090572470,6090588890,6090629780,6090612720,6090601850,6090535530,6090547860,6090601850,6090566330,6090613000,6090595300,6090510180,6090531830,6090527450,6090524660,6090499970,6090502220,6090484790,6090536080,6090509600,6090529510,6090525490,6090552830,6090550430,6090560950,6090483660,6090543710,6090558840,6090553570,6090567110)

# generating random selection of 100 hydrobasins
random_basin <- sample(1:3389, 100, replace=F)
basin_id <- hydrobasin[random_basin,]$HYBAS_ID

tictoc::tic()
   no_cores <- detectCores()
   cl <- makeCluster(no_cores) # setting up number of cores
   registerDoParallel(cl) # parallelizing on them
   foreach(i = basin_id, .packages=c('dplyr', 'terra', 'sf')) %dopar%  {
     
     for (y in time_span){ #[seq(1,18,3)]
      vulnerability(hydrobasin, i, y, time_span)
       gc()
     }
     
   }
   stopCluster(cl)
tictoc::toc()

# 42.39 sec elapsed

```